Vagrant.configure("2") do |config|
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "1024"
    vb.cpus = 1
  end

  # Desactivar el forward automático de SSH para evitar conflictos
  config.vm.network "forwarded_port", guest: 22, host: 2222, disabled: true

  # CONTROL NODE
  config.vm.define "control-node" do |control|
    control.vm.box = "bento/ubuntu-22.04"
    control.vm.hostname = "control-node"
    control.vm.network "private_network", ip: "192.168.56.10"
    control.vm.synced_folder ".", "/vagrant"

    control.vm.provision "shell", inline: <<-SHELL
      set -e
      sudo apt update
      sudo apt install -y gnupg software-properties-common curl unzip

      # Install Terraform (HashiCorp APT) and Ansible
      curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
      echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
      sudo apt update
      sudo apt install -y terraform ansible

      # Generate ssh keys for control -> web and put them in the shared folder
      mkdir -p /vagrant/ssh_keys
      if [ ! -f /vagrant/ssh_keys/id_rsa ]; then
        ssh-keygen -t rsa -b 2048 -f /vagrant/ssh_keys/id_rsa -N "" -C "vagrant-control"
        chown -R vagrant:vagrant /vagrant/ssh_keys
      fi

      # Ensure copy to ~/.ssh with proper permissions
      mkdir -p /home/vagrant/.ssh
      cp /vagrant/ssh_keys/id_rsa /home/vagrant/.ssh/id_rsa
      chown vagrant:vagrant /home/vagrant/.ssh/id_rsa
      chmod 600 /home/vagrant/.ssh/id_rsa
    SHELL
  end

  # WEB NODE (target)
  config.vm.define "web-node" do |web|
    web.vm.box = "bento/ubuntu-22.04"
    web.vm.hostname = "web-node"
    web.vm.network "private_network", ip: "192.168.56.20"

    # Forward Apache port 80 on guest → 8080 on host
    web.vm.network "forwarded_port", guest: 80, host: 8080

    web.vm.synced_folder ".", "/vagrant"

    web.vm.provision "shell", inline: <<-SHELL
      set -e
      sudo apt update
      sudo apt install -y openssh-server
      # Ensure the vagrant user has the control node public key
      mkdir -p /home/vagrant/.ssh
      if [ -f /vagrant/ssh_keys/id_rsa.pub ]; then
        cat /vagrant/ssh_keys/id_rsa.pub >> /home/vagrant/.ssh/authorized_keys
        chown -R vagrant:vagrant /home/vagrant/.ssh
        chmod 600 /home/vagrant/.ssh/authorized_keys
      fi
    SHELL
  end
end
